---
interface Props {
  src?: string;
  sources?: Array<{
    src: string;
    type?: string; // e.g., "video/webm", "video/mp4"
  }>;
  poster?: string;
  autoplay?: boolean;
  controls?: boolean;
  loop?: boolean;
  muted?: boolean;
  preload?: "none" | "metadata" | "auto";
  className: string;
}

const {
  src,
  sources = [],
  poster,
  className,
  autoplay = true,
  controls = false,
  loop = true,
  muted = true,
  preload = "none",
} = Astro.props;
---

<video
  playsinline
  controls={controls}
  loop={loop}
  muted={muted}
  preload={preload}
  poster={poster}
  data-autoplay={autoplay}
  class={`w-full bg-panel ${className || ""}`}
>
  {
    sources && sources.length > 0
      ? sources.map((s) => <source src={s.src} type={s.type} />)
      : src && <source src={src} />
  }
</video>

<script>
  const videos = document.querySelectorAll("video[data-autoplay]");
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const video = entry.target as HTMLVideoElement;
        if (entry.isIntersecting) {
          video.play().catch(() => {
            // Autoplay was prevented
          });
        } else {
          video.pause();
        }
      });
    },
    { threshold: 0.25 },
  );

  videos.forEach((video) => observer.observe(video));
</script>
